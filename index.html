<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Functional AgriSys Management Dashboard (Frontend Only)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for visual charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* Custom scrollbar for themed look */
        #content::-webkit-scrollbar { width: 8px; }
        #content::-webkit-scrollbar-track { background: #E5E7EB; }
        #content::-webkit-scrollbar-thumb { background-color: #A9D18E; border-radius: 20px; border: 2px solid #E5E7EB; }

        /* Hide sidebar toggle on desktop */
        .sidebar-toggle-mobile { display: none; }
        
        /* Transition for smooth sidebar open/close */
        #sidebar { transition: transform 0.3s ease-in-out; }

        /* Chart container height for consistent rendering */
        .chart-container { height: 400px; }

        /* Media queries for responsiveness */
        @media (max-width: 768px) {
            #sidebar {
                position: fixed;
                height: 100%;
                z-index: 50;
                transform: translateX(-100%);
            }
            #sidebar.open {
                transform: translateX(0);
            }
            .sidebar-toggle-mobile {
                display: block;
                z-index: 60; /* Above sidebar */
                position: fixed;
                top: 1rem;
                left: 1rem;
            }
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'agri-green': '#38761D', // Primary Green
                        'agri-dark': '#1C370E', // Darker Green (for background/text)
                        'agri-yellow': '#F9D749', // Accent Yellow
                        'agri-light': '#D9EAD3', // Light Green (for hover/accents)
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="font-sans antialiased bg-gray-50">

    <!-- Mobile Sidebar Toggle -->
    <button id="sidebar-toggle" class="sidebar-toggle-mobile bg-agri-green text-white p-3 rounded-full shadow-lg hover:bg-agri-dark transition">
        <i class="fas fa-bars"></i>
    </button>

    <div id="app" class="flex h-screen">
        <!-- Sidebar Navigation -->
        <nav id="sidebar" class="w-64 bg-agri-dark text-white shadow-2xl flex-shrink-0 md:relative">
            <div class="p-6">
                <h1 class="text-3xl font-extrabold text-agri-yellow tracking-tight">AgriSys</h1>
                <p class="text-xs text-agri-light opacity-75 mt-1">Management Dashboard</p>
            </div>
            
            <ul class="space-y-2 p-4 pt-0">
                <li class="nav-item" data-page="dashboard"><i class="fas fa-chart-line w-5 mr-3"></i>Dashboard</li>
                <li class="nav-item" data-page="marketplace"><i class="fas fa-store w-5 mr-3"></i>Marketplace</li>
                <li class="nav-item relative" data-page="cart">
                    <i class="fas fa-shopping-cart w-5 mr-3"></i>
                    Shopping Cart
                    <span id="cart-count-badge" class="absolute top-1 right-2 inline-flex items-center justify-center px-2 py-0.5 text-xs font-bold leading-none text-red-100 bg-red-600 rounded-full hidden">0</span>
                </li>
                <li class="nav-item" data-page="forms"><i class="fas fa-edit w-5 mr-3"></i>Data Input Forms</li>
                <li class="nav-item" data-page="records"><i class="fas fa-table w-5 mr-3"></i>All Records</li>
                <li class="nav-item" data-page="reports"><i class="fas fa-file-alt w-5 mr-3"></i>System Report</li>
            </ul>
        </nav>

        <!-- Main Content Area -->
        <main id="content" class="flex-1 overflow-y-auto p-4 md:p-8">
            <!-- Content will be injected here by JavaScript -->
            <div id="page-content">
                <div class="flex flex-col items-center justify-center h-full">
                    <i class="fas fa-tractor fa-spin text-5xl text-agri-green mb-4"></i>
                    <p class="text-lg text-agri-dark">Initializing the system...</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- Initial Mock Data (used if localStorage is empty) ---
        const DEFAULT_SEED_LOTS = [
            { id: 'seed-1', seedType: 'Hybrid Corn', lotNumber: 'C-2024-H01', germinationRate: 98, dateAcquired: '2024-03-15', recordedBy: 'Initial Data', timestamp: '2024-03-15T10:00:00Z' },
            { id: 'seed-2', seedType: 'Soybean (Roundup Ready)', lotNumber: 'S-2024-B03', germinationRate: 92, dateAcquired: '2024-04-01', recordedBy: 'Initial Data', timestamp: '2024-04-01T10:00:00Z' },
            { id: 'seed-3', seedType: 'Winter Wheat', lotNumber: 'W-2023-F12', germinationRate: 85, dateAcquired: '2023-11-20', recordedBy: 'Initial Data', timestamp: '2023-11-20T10:00:00Z' },
            { id: 'seed-4', seedType: 'Hybrid Corn', lotNumber: 'C-2025-H02', germinationRate: 97, dateAcquired: '2025-01-05', recordedBy: 'Initial Data', timestamp: '2025-01-05T10:00:00Z' },
        ];

        const DEFAULT_FERT_APPS = [
            { id: 'fert-1', fertilizerName: '15-15-15 NPK', fieldId: 'Field A-1', dosage: 150, applicationDate: '2024-05-10', recordedBy: 'Initial Data', timestamp: '2024-05-10T12:00:00Z' },
            { id: 'fert-2', fertilizerName: 'Urea (46-0-0)', fieldId: 'Field B-2', dosage: 80, applicationDate: '2024-06-25', recordedBy: 'Initial Data', timestamp: '2024-06-25T12:00:00Z' },
            { id: 'fert-3', fertilizerName: 'Potash (0-0-60)', fieldId: 'Field A-1', dosage: 50, applicationDate: '2024-07-01', recordedBy: 'Initial Data', timestamp: '2024-07-01T12:00:00Z' },
            { id: 'fert-4', fertilizerName: '10-20-10 NPK', fieldId: 'Field C-3', dosage: 175, applicationDate: '2025-02-15', recordedBy: 'Initial Data', timestamp: '2025-02-15T12:00:00Z' },
        ];
        
        // Global Data Stores (Now loaded from localStorage or initialized with defaults)
        let seedLots = JSON.parse(localStorage.getItem('seedLots'));
        let fertilizerApplications = JSON.parse(localStorage.getItem('fertilizerApplications'));
        let cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
        
        // --- Data Persistence and Utilities (using localStorage) ---
        
        function saveData(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
            // Re-render the current page to reflect changes instantly
            renderPage(currentPage);
        }

        // Configuration
        const PAGES = {
            DASHBOARD: 'dashboard',
            MARKETPLACE: 'marketplace',
            CART: 'cart',
            FORMS: 'forms',
            RECORDS: 'records',
            REPORTS: 'reports',
        };
        
        // Mock Product Data
        const PRODUCTS = [
            { id: 'cornseed', name: 'Premium Hybrid Corn Seed', description: 'High-yield, disease-resistant corn seed for optimal production.', price: 120, unit: 'bag', type: 'seed', icon: 'fas fa-seedling' },
            { id: 'wheatseed', name: 'Winter Wheat Seed', description: 'Hardy variety, excellent for cold climates and early spring planting.', price: 95, unit: 'bag', type: 'seed', icon: 'fas fa-wheat-awn' },
            { id: 'npkfert', name: '10-20-10 NPK Fertilizer', description: 'Balanced granular fertilizer for early stage growth and root development.', price: 45, unit: 'kg', type: 'fertilizer', icon: 'fas fa-flask' },
            { id: 'ureafert', name: 'Urea Fertilizer (46-0-0)', description: 'High nitrogen source for mid-season vegetative growth.', price: 30, unit: 'kg', type: 'fertilizer', icon: 'fas fa-flask' },
        ];


        /**
         * Checks localStorage for data and initializes with defaults if empty.
         */
        function initializeData() {
            let dataInitialized = false;
            
            if (!seedLots || seedLots.length === 0) {
                seedLots = DEFAULT_SEED_LOTS;
                localStorage.setItem('seedLots', JSON.stringify(seedLots));
                dataInitialized = true;
            }
            
            if (!fertilizerApplications || fertilizerApplications.length === 0) {
                fertilizerApplications = DEFAULT_FERT_APPS;
                localStorage.setItem('fertilizerApplications', JSON.stringify(fertilizerApplications));
                dataInitialized = true;
            }
            
            if (dataInitialized) {
                console.log("Local storage was empty. Initial data loaded for demonstration.");
            }
        }

        /**
         * Updates the shopping cart badge count in the navigation.
         */
        function updateCartCount() {
            const badge = document.getElementById('cart-count-badge');
            if (badge) {
                const count = cartItems.reduce((sum, item) => sum + (item.quantity || 0), 0);
                badge.textContent = count;
                if (count > 0) {
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }

        /**
         * Calculates mock data metrics based on current data stores.
         * @returns {object} Calculated metrics for the dashboard.
         */
        function calculateMetrics() {
            const metrics = {
                totalSeedLots: seedLots.length,
                totalFertApps: fertilizerApplications.length,
                avgGermination: 0,
                uniqueCrops: new Set(),
                avgDosage: 0
            };

            // Seed Lot Metrics
            if (seedLots.length > 0) {
                const totalRate = seedLots.reduce((sum, lot) => sum + (lot.germinationRate || 0), 0);
                metrics.avgGermination = (totalRate / seedLots.length).toFixed(1);
                
                seedLots.forEach(lot => {
                    if (lot.seedType) metrics.uniqueCrops.add(lot.seedType);
                });
            }

            // Fertilizer Metrics
            if (fertilizerApplications.length > 0) {
                const totalDosage = fertilizerApplications.reduce((sum, app) => sum + (app.dosage || 0), 0);
                metrics.avgDosage = (totalDosage / fertilizerApplications.length).toFixed(0);
            }

            return metrics;
        }

        // --- Chart Generation ---

        let chartInstances = {}; // Store chart instances to destroy them before re-creation

        function initializeChart(canvasId, type, label, labels, dataSets, color) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            
            if (chartInstances[canvasId]) {
                chartInstances[canvasId].destroy();
            }

            const chartConfig = {
                type: type,
                data: {
                    labels: labels,
                    datasets: dataSets || [{
                        label: label,
                        data: dataSets ? null : [],
                        backgroundColor: color + '90',
                        borderColor: color,
                        borderWidth: 2,
                        tension: type === 'line' ? 0.4 : 0,
                        fill: type === 'line' ? true : false,
                        pointRadius: type === 'line' ? 5 : 0,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        title: { display: true, text: label, font: { size: 16 } }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            };
            
            if (canvasId === 'germinationChart') {
                const germinationData = {};
                seedLots.forEach(lot => {
                    const date = lot.dateAcquired || 'Unknown';
                    germinationData[date] = (germinationData[date] || []).concat(lot.germinationRate);
                });

                const sortedDates = Object.keys(germinationData).sort();
                const avgRates = sortedDates.map(date => 
                    (germinationData[date].reduce((a, b) => a + b, 0) / germinationData[date].length).toFixed(1)
                );

                chartConfig.data.labels = sortedDates;
                chartConfig.data.datasets = [{
                    label: 'Avg. Germination Rate (%)',
                    data: avgRates,
                    backgroundColor: '#38761D90',
                    borderColor: '#38761D',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: false,
                    pointRadius: 5,
                }];
            } else if (canvasId === 'dosageChart') {
                const dosageData = {};
                fertilizerApplications.forEach(app => {
                    const month = (app.applicationDate || '2000-01-01').substring(0, 7);
                    dosageData[month] = (dosageData[month] || []).concat(app.dosage);
                });

                const sortedMonths = Object.keys(dosageData).sort();
                const totalDosages = sortedMonths.map(month => 
                    dosageData[month].reduce((a, b) => a + b, 0)
                );

                chartConfig.data.labels = sortedMonths;
                chartConfig.data.datasets = [{
                    label: 'Total Fertilizer Dosage by Month (kg/Ha)',
                    data: totalDosages,
                    backgroundColor: '#F9D749',
                    borderColor: '#F9D749',
                    borderWidth: 1,
                }];
            }


            chartInstances[canvasId] = new Chart(ctx.getContext('2d'), chartConfig);
        }

        // --- Page Content Functions ---

        function renderDashboardCards(metrics) {
            const cards = [
                {
                    title: "Total Seed Lots Tracked",
                    value: metrics.totalSeedLots,
                    icon: 'fas fa-seedling',
                    detail: `Tracking ${metrics.uniqueCrops.size} unique crop types.`,
                    color: 'bg-green-600'
                },
                {
                    title: "Avg. Germination Rate (Latest)",
                    value: metrics.avgGermination + '%',
                    icon: 'fas fa-percent',
                    detail: `Based on ${metrics.totalSeedLots} lot${metrics.totalSeedLots === 1 ? '' : 's'}.`,
                    color: 'bg-agri-dark'
                },
                {
                    title: "Total Fertilizer Applications",
                    value: metrics.totalFertApps,
                    icon: 'fas fa-flask',
                    detail: `Avg dosage: ${metrics.avgDosage} kg/Ha.`,
                    color: 'bg-yellow-600'
                },
                {
                    title: "Shopping Cart Items",
                    value: cartItems.reduce((sum, item) => sum + (item.quantity || 0), 0),
                    icon: 'fas fa-shopping-cart',
                    detail: `Total value: $${cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0).toFixed(2)}.`,
                    color: 'bg-orange-500' 
                }
            ];

            return cards.map(card => {
                const valueHTML = `<p class="text-3xl font-extrabold text-gray-900 mt-1">${card.value}</p>`;
                
                return `
                    <div class="bg-white p-6 rounded-xl shadow-lg flex items-start space-x-4 transition transform hover:scale-[1.02]">
                        <div class="p-3 ${card.color} text-white rounded-full text-2xl shadow-md">
                            <i class="${card.icon}"></i>
                        </div>
                        <div class="flex-1 min-w-0"> 
                            <p class="text-sm font-medium text-gray-500">${card.title}</p>
                            ${valueHTML}
                            <p class="text-xs text-gray-400 mt-2">${card.detail}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderDashboard() {
            const metrics = calculateMetrics();
            const contentDiv = document.getElementById('page-content');
            contentDiv.innerHTML = `
                <h2 class="text-3xl font-bold text-agri-dark mb-8">Farm Analytics Dashboard</h2>
                
                <!-- Key Metrics Grid -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
                    ${renderDashboardCards(metrics)}
                </div>

                <!-- Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Avg. Germination Rate Chart -->
                    <div class="bg-white p-6 rounded-xl shadow-lg chart-container">
                        <canvas id="germinationChart"></canvas>
                    </div>
                    <!-- Monthly Dosage Chart -->
                    <div class="bg-white p-6 rounded-xl shadow-lg chart-container">
                        <canvas id="dosageChart"></canvas>
                    </div>
                </div>
            `;

            setTimeout(() => {
                initializeChart('germinationChart', 'line', 'Avg. Germination Rate Over Time', [], null, '#38761D');
                initializeChart('dosageChart', 'bar', 'Total Fertilizer Dosage by Month', [], null, '#F9D749');
            }, 50);
        }

        // --- Marketplace Functions ---
        
        function addToCart(productId) {
            const product = PRODUCTS.find(p => p.id === productId);
            if (!product) return;

            const existingItem = cartItems.find(item => item.productId === productId);
            
            if (existingItem) {
                existingItem.quantity += 1;
                alertMessage(`${product.name} quantity increased in cart!`, 'success');
            } else {
                cartItems.push({
                    id: Math.random().toString(36).substring(2, 9), // Mock ID
                    productId: product.id,
                    name: product.name,
                    price: product.price,
                    unit: product.unit,
                    quantity: 1,
                    timestamp: new Date().toISOString()
                });
                alertMessage(`${product.name} added to cart!`, 'success');
            }
            
            saveData('cartItems', cartItems);
        }

        function renderMarketplace() {
            const contentDiv = document.getElementById('page-content');
            contentDiv.innerHTML = `
                <h2 class="text-3xl font-bold text-agri-dark mb-8">AgriSys Supply Marketplace</h2>
                <div id="alert-container" class="mb-6"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    ${PRODUCTS.map(product => `
                        <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-agri-yellow flex flex-col justify-between transition transform hover:scale-[1.03] hover:shadow-xl">
                            <div>
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-xl font-semibold text-agri-dark">${product.name}</h3>
                                    <i class="${product.icon} text-2xl text-agri-green"></i>
                                </div>
                                <p class="text-gray-600 mb-4 text-sm">${product.description}</p>
                                <p class="text-3xl font-bold text-agri-yellow mb-4">
                                    $${product.price.toFixed(2)} / ${product.unit}
                                </p>
                            </div>
                            <button 
                                onclick="window.addToCart('${product.id}')" 
                                class="mt-4 w-full py-2 px-4 rounded-lg shadow-md text-sm font-medium text-white bg-agri-green hover:bg-agri-dark transition">
                                <i class="fas fa-cart-plus mr-2"></i> Add to Cart
                            </button>
                        </div>
                    `).join('')}
                </div>
                <p class="text-center text-gray-400 mt-10">Total items in your cart: ${cartItems.reduce((sum, item) => sum + (item.quantity || 0), 0)}</p>
            `;
            // Expose function globally for onclick to work
            window.addToCart = addToCart;
        }

        // --- Cart Functions ---

        function updateQuantity(itemId, change) {
            const item = cartItems.find(i => i.id === itemId);
            if (!item) return;
            
            item.quantity += change;

            if (item.quantity <= 0) {
                cartItems = cartItems.filter(i => i.id !== itemId);
                alertMessage(`${item.name} removed from cart.`, 'success');
            }
            
            saveData('cartItems', cartItems);
        }
        
        function removeItem(itemId) {
            const item = cartItems.find(i => i.id === itemId);
            if (!item) return;

            cartItems = cartItems.filter(i => i.id !== itemId);
            alertMessage(`${item.name} removed from cart.`, 'success');
            
            saveData('cartItems', cartItems);
        }

        function processPayment(event) {
            event.preventDefault();
            if (cartItems.length === 0) {
                alertMessage('Your cart is empty!', 'error');
                return;
            }
            
            const total = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            // --- MOCK PAYMENT SIMULATION ---
            const paymentSuccess = Math.random() > 0.1; // 90% success rate

            if (paymentSuccess) {
                // 1. Clear the cart
                cartItems = [];
                saveData('cartItems', cartItems);
                
                alertMessage(`Payment successful! $${total.toFixed(2)} charged. Transaction complete (Order not tracked).`, 'success');
                
                // Manually navigate back to the Marketplace after successful checkout
                window.history.pushState({ page: PAGES.MARKETPLACE }, '', `#${PAGES.MARKETPLACE}`);
                renderPage(PAGES.MARKETPLACE); 

            } else {
                alertMessage('Payment failed: Card declined or service error. Please try again.', 'error');
            }
        }

        function renderCart() {
            const contentDiv = document.getElementById('page-content');
            const total = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            const cartItemsHtml = cartItems.length > 0 ? cartItems.map(item => `
                <li class="flex justify-between items-center py-4 border-b">
                    <div class="flex-1">
                        <p class="font-semibold text-agri-dark">${item.name}</p>
                        <p class="text-sm text-gray-500">$${item.price.toFixed(2)} / ${item.unit}</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button onclick="window.updateQuantity('${item.id}', -1)" class="p-2 text-agri-dark border rounded-full hover:bg-gray-100 transition disabled:opacity-50 disabled:cursor-not-allowed" ${item.quantity <= 1 ? 'disabled' : ''}><i class="fas fa-minus text-xs"></i></button>
                        <span class="font-medium w-6 text-center">${item.quantity}</span>
                        <button onclick="window.updateQuantity('${item.id}', 1)" class="p-2 text-agri-dark border rounded-full hover:bg-gray-100 transition"><i class="fas fa-plus text-xs"></i></button>
                        <button onclick="window.removeItem('${item.id}')" class="p-2 text-red-500 hover:text-red-700 transition ml-4"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="font-bold text-lg w-20 text-right">$${(item.price * item.quantity).toFixed(2)}</div>
                </li>
            `).join('') : '<p class="text-center py-10 text-gray-500 italic">Your cart is empty! Time to stock up on supplies.</p>';

            contentDiv.innerHTML = `
                <h2 class="text-3xl font-bold text-agri-dark mb-8">Shopping Cart & Checkout</h2>
                <div id="alert-container" class="mb-6"></div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Cart Items Column -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg h-min">
                        <h3 class="text-2xl font-semibold mb-4 text-agri-green">Review Items (${cartItems.length})</h3>
                        <ul>
                            ${cartItemsHtml}
                        </ul>
                        <div class="mt-6 pt-4 border-t border-gray-200 flex justify-between items-center">
                            <p class="text-xl font-semibold text-gray-600">Subtotal:</p>
                            <p class="text-3xl font-extrabold text-agri-dark">$${total.toFixed(2)}</p>
                        </div>
                    </div>
                    
                    <!-- Checkout Column -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-agri-green h-min">
                        <h3 class="text-2xl font-semibold mb-4 text-agri-dark">Payment Details</h3>
                        <form id="checkout-form" onsubmit="window.processPayment(event); return false;">
                            
                            <label for="name" class="block text-sm font-medium text-gray-700 mt-3">Full Name</label>
                            <input id="name" type="text" value="Jane Doe" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50">
                            
                            <label for="address" class="block text-sm font-medium text-gray-700 mt-3">Shipping Address</label>
                            <input id="address" type="text" value="123 Farm Rd, Rural Town" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50">

                            <label for="payment-method" class="block text-sm font-medium text-gray-700 mt-3">Payment Method (Mock)</label>
                            <select id="payment-method" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50">
                                <option>Credit Card (Mock)</option>
                                <option>Bank Transfer (Mock)</option>
                            </select>

                            <p class="text-sm text-gray-500 mt-6 p-3 bg-agri-light rounded-lg">
                                Total Due: <span class="font-bold text-agri-dark text-lg">$${total.toFixed(2)}</span>
                            </p>

                            <button type="submit" ${cartItems.length === 0 ? 'disabled' : ''} 
                                class="mt-6 w-full py-3 px-4 rounded-lg shadow-xl text-lg font-bold text-white transition 
                                ${cartItems.length === 0 ? 'bg-gray-400 cursor-not-allowed' : 'bg-agri-green hover:bg-agri-dark transform hover:scale-[1.01]'}">
                                <i class="fas fa-credit-card mr-2"></i> Pay Now ($${total.toFixed(2)})
                            </button>
                        </form>
                    </div>
                </div>
            `;
            // Expose functions globally for onclick to work
            window.updateQuantity = updateQuantity;
            window.removeItem = removeItem;
            window.processPayment = processPayment;
        }

        // --- Data Input Forms, Records, Reports ---
        
        function generateUniqueId(prefix) {
            return prefix + '-' + Math.random().toString(36).substring(2, 9);
        }

        function handleFormSubmit(event, collectionName, dataArray) {
            event.preventDefault();
            const form = event.target;
            const data = {};
            
            Array.from(form.elements).forEach(element => {
                if (element.name) {
                    let value = element.value;
                    if (element.type === 'number') {
                        value = parseFloat(value);
                    }
                    if (value === 'None' || value === '') {
                        value = null;
                    }
                    data[element.name] = value;
                }
            });

            const newData = {
                id: generateUniqueId(collectionName),
                ...data,
                timestamp: new Date().toISOString(),
                recordedBy: 'Local User'
            };
            
            // Update the correct global array
            if (collectionName === 'seedLots') {
                seedLots.push(newData);
                saveData('seedLots', seedLots);
            } else if (collectionName === 'fertilizerApplications') {
                fertilizerApplications.push(newData);
                saveData('fertilizerApplications', fertilizerApplications);
            } else {
                console.error("Unknown collection name:", collectionName);
                alertMessage('Failed to save record: Unknown collection.', 'error');
                return;
            }
            
            form.reset();
            alertMessage(`Successfully saved new ${collectionName.slice(0, -1)} record!`, 'success');
        }

        function renderForms() {
            const contentDiv = document.getElementById('page-content');
            contentDiv.innerHTML = `
                <h2 class="text-3xl font-bold text-agri-dark mb-8">Data Input Forms</h2>
                <div id="alert-container" class="mb-6"></div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    ${renderFormCard('SeedLot', 'fas fa-seedling', 'Record new seed batch data, including lot number, supplier, and initial germination test results.', [
                        { label: "Seed Type", name: "seedType", type: "text", placeholder: "e.g., Hybrid Corn" },
                        { label: "Lot Number", name: "lotNumber", type: "text", placeholder: "S-2025-CORN-005" },
                        { label: "Germination Rate (%)", name: "germinationRate", type: "number", min: 0, max: 100, placeholder: "95" },
                        { label: "Date Acquired", name: "dateAcquired", type: "date" }
                    ])}
                    
                    ${renderFormCard('FertilizerApplication', 'fas fa-flask', 'Log the type, quantity, and date of fertilizer applied to a specific field section.', [
                        { label: "Fertilizer Name", name: "fertilizerName", type: "text", placeholder: "e.g., 10-20-10 NPK" },
                        { label: "Field ID", name: "fieldId", type: "text", placeholder: "Field A-2" },
                        { label: "Dosage (kg/Ha)", name: "dosage", type: "number", min: 0, placeholder: "180" },
                        { label: "Application Date", name: "applicationDate", type: "date" }
                    ])}
                </div>
            `;
            
            // Attach listeners to the forms using the correct array reference
            document.getElementById('form-SeedLot').addEventListener('submit', (e) => handleFormSubmit(e, 'seedLots', seedLots));
            document.getElementById('form-FertilizerApplication').addEventListener('submit', (e) => handleFormSubmit(e, 'fertilizerApplications', fertilizerApplications));
        }

        function renderFormCard(title, icon, description, fields) {
            const formFields = fields.map(field => {
                const isRequired = field.type !== 'select';
                let inputHtml = '';

                if (field.type === "select") {
                    const options = field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                    inputHtml = `
                        <select id="${field.name}" name="${field.name}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 focus:border-agri-green focus:ring focus:ring-agri-green/50">
                            ${options}
                        </select>
                    `;
                } else {
                    const minMax = (field.min !== undefined ? `min="${field.min}"` : '') + (field.max !== undefined ? `max="${field.max}"` : '');
                    inputHtml = `
                        <input id="${field.name}" name="${field.name}" type="${field.type}" placeholder="${field.placeholder || ''}" ${minMax} ${isRequired ? 'required' : ''} class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-50 focus:border-agri-green focus:ring focus:ring-agri-green/50">
                    `;
                }
                
                return `
                    <label for="${field.name}" class="block text-sm font-medium text-gray-700 mt-3">${field.label}${isRequired ? '<span class="text-red-500 ml-1">*</span>' : ''}</label>
                    ${inputHtml}
                `;
            }).join('');

            return `
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-agri-green">
                    <div class="flex items-center space-x-3 mb-4">
                        <i class="${icon} text-2xl text-agri-dark"></i>
                        <h3 class="text-xl font-semibold text-agri-dark">${title}</h3>
                    </div>
                    <p class="text-sm text-gray-500 mb-4">${description}</p>
                    <form id="form-${title}" onsubmit="return false;">
                        ${formFields}
                        <button type="submit" class="mt-6 w-full py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-agri-green hover:bg-agri-dark transition">
                            Save ${title} Record
                        </button>
                    </form>
                </div>
            `;
        }

        function renderRecords() {
            const contentDiv = document.getElementById('page-content');
            contentDiv.innerHTML = `
                <h2 class="text-3xl font-bold text-agri-dark mb-8">All System Records</h2>
                <div class="flex items-center p-3 mb-6 bg-agri-light rounded-xl shadow-inner text-agri-dark">
                    <i class="fas fa-database mr-3"></i>
                    <p class="text-sm font-medium">All records are pulled from your browser's LocalStorage. The initial demonstration data is now included.</p>
                </div>

                <!-- Seed Lots Table -->
                <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                    <h3 class="text-2xl font-semibold text-agri-green mb-4 border-b pb-2">Seed Lots (${seedLots.length} Total)</h3>
                    ${renderTable(seedLots, 'seedLots')}
                </div>
                
                <!-- Fertilizer Applications Table -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-2xl font-semibold text-agri-green mb-4 border-b pb-2">Fertilizer Applications (${fertilizerApplications.length} Total)</h3>
                    ${renderTable(fertilizerApplications, 'fertilizerApplications')}
                </div>
            `;
        }

        function renderTable(data, type) {
            if (data.length === 0) {
                return `<p class="text-gray-500 italic">No ${type.replace(/([A-Z])/g, ' $1').toLowerCase()} records found. Please use the Data Input Forms to add some.</p>`;
            }

            let headers = [];
            if (type === 'seedLots') {
                headers = ['Seed Type', 'Lot Number', 'Germination Rate (%)', 'Date Acquired', 'Recorded By'];
            } else if (type === 'fertilizerApplications') {
                headers = ['Fertilizer Name', 'Field ID', 'Dosage (kg/Ha)', 'Application Date', 'Recorded By'];
            }

            const headerHtml = headers.map(h => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('');

            const rowHtml = data.map(doc => {
                let fields = [];
                if (type === 'seedLots') {
                    fields = [
                        doc.seedType,
                        doc.lotNumber,
                        doc.germinationRate,
                        doc.dateAcquired,
                        doc.recordedBy
                    ];
                } else if (type === 'fertilizerApplications') {
                    fields = [
                        doc.fertilizerName,
                        doc.fieldId,
                        doc.dosage,
                        doc.applicationDate,
                        doc.recordedBy
                    ];
                }

                const cellHtml = fields.map(f => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${f || 'N/A'}</td>`).join('');
                
                return `<tr class="hover:bg-gray-50">${cellHtml}</tr>`;
            }).join('');

            return `
                <div class="overflow-x-auto border border-gray-200 rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                ${headerHtml}
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${rowHtml}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderReports() {
            const reportSections = [
                { title: "1. Introduction", content: "The Seeds and Fertilizer Management System (SFMS) is now running as a pure client-side application using JavaScript." },
                { title: "2. Data Flow and Storage", content: "All application data, including farm records and shopping cart contents, is stored entirely in the browser's \`localStorage\`. This provides persistence across sessions but is not shared between different browsers or devices." },
                { title: "3. Simulated Functionality", content: "The Marketplace, Cart management, and Checkout process are fully simulated using client-side logic. Upon successful mock payment, the cart is cleared and a confirmation message is displayed, but the order is *not* tracked in this simplified version." },
                { title: "4. Technical Stack", content: "The system is built using HTML5, Tailwind CSS for aesthetics and responsiveness, and Vanilla JavaScript for all logic, state management, and DOM manipulation. Chart visualization is handled by Chart.js." },
            ];
            
            const sectionsHTML = reportSections.map(section => `
                <div class="mb-6 pb-4 border-b border-gray-200">
                    <h3 class="text-xl font-semibold text-agri-green mb-2">${section.title}</h3>
                    <p class="text-gray-700 leading-relaxed">${section.content}</p>
                </div>
            `).join('');

            const contentDiv = document.getElementById('page-content');
            contentDiv.innerHTML = `
                <h2 class="text-3xl font-bold text-agri-dark mb-4">System Analysis and Design Report (Frontend Only)</h2>
                <p class="text-gray-600 mb-8 italic">Focusing on Client-Side Implementation and LocalStorage</p>
                
                <div class="bg-white p-8 rounded-xl shadow-2xl">
                    ${sectionsHTML}
                    <div class="text-center mt-8">
                        <i class="fas fa-database text-4xl text-agri-yellow"></i>
                        <p class="text-sm text-gray-500 mt-2">Diagram: Data Flow (Local Storage)</p>
                        
                    </div>
                </div>
            `;
        }

        // --- UI Feedback and Navigation ---

        let currentPage = PAGES.DASHBOARD;
        let timeoutId;

        function alertMessage(message, type) {
            const alertContainer = document.getElementById('alert-container');
            if (!alertContainer) return;
            
            clearTimeout(timeoutId);

            const colorMap = {
                'success': 'bg-green-100 text-green-800 border-green-400',
                'error': 'bg-red-100 text-red-800 border-red-400'
            };

            alertContainer.innerHTML = `
                <div class="p-3 border-l-4 rounded-lg ${colorMap[type]} transition-opacity duration-300" role="alert">
                    <p class="font-bold">${type.toUpperCase()}</p>
                    <p>${message}</p>
                </div>
            `;

            timeoutId = setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }

        function renderPage(pageName) {
            const pageContent = document.getElementById('page-content');
            const navItems = document.querySelectorAll('.nav-item');
            
            // Update active state in sidebar
            navItems.forEach(item => {
                item.classList.add('p-3', 'rounded-lg', 'cursor-pointer', 'transition', 'hover:bg-green-700');
                if (item.dataset.page === pageName) {
                    item.classList.add('bg-agri-green', 'font-bold');
                    item.classList.remove('hover:bg-green-700');
                } else {
                    item.classList.remove('bg-agri-green', 'font-bold');
                }
            });

            // Toggle sidebar visibility on mobile
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.remove('open');
            
            // Render the specific page content
            switch (pageName) {
                case PAGES.DASHBOARD:
                    renderDashboard();
                    break;
                case PAGES.MARKETPLACE:
                    renderMarketplace();
                    break;
                case PAGES.CART:
                    renderCart();
                    break;
                case PAGES.FORMS:
                    renderForms();
                    break;
                case PAGES.RECORDS:
                    renderRecords();
                    break;
                case PAGES.REPORTS:
                    renderReports();
                    break;
                default:
                    pageContent.innerHTML = `<h2 class="text-3xl font-bold text-red-500">404: Page Not Found</h2>`;
            }

            currentPage = pageName;
            updateCartCount(); // Ensure the count is always updated after page render
        }

        function initApp() {
            // Check for and load initial data
            initializeData();

            // Set up navigation listeners
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const page = e.currentTarget.dataset.page;
                    window.history.pushState({ page: page }, '', `#${page}`);
                    renderPage(page);
                });
            });

            // Setup mobile toggle
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebar = document.getElementById('sidebar');
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('open');
            });
            
            // Handle browser back/forward buttons
            window.addEventListener('popstate', (e) => {
                const page = e.state ? e.state.page : PAGES.DASHBOARD;
                renderPage(page);
            });
            
            // Initial render
            renderPage(window.location.hash.substring(1) || PAGES.DASHBOARD);
        }

        // Start the application
        window.onload = initApp;
    </script>
</body>
</html>
